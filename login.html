<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <link rel="icon" href="data:,">
  <style>
    * { box-sizing: border-box; font-family: "Poppins", sans-serif; }

    body{
      min-height: 100vh;
      margin: 0;
      display: grid;
      place-items: center;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(110,231,255,.55), transparent 60%),
        radial-gradient(900px 500px at 90% 80%, rgba(255,214,110,.55), transparent 60%),
        linear-gradient(135deg, #f7fbff, #fff7fb);
      padding: 28px 16px;
    }

    /* From Uiverse.io by craig_8499 (modified colors + responsive + click-to-open) */
    .login-container{
      position: relative;
      perspective: 1000px;
      width: 360px;
      max-width: 92vw;
    }

    .login-card{
      position: relative;
      width: 100%;
      height: 90px;
      border-radius: 14px;
      background: linear-gradient(135deg, #6ee7ff, #ffd66e);
      border: 4px solid #111;
      box-shadow:
        10px 10px 0 #111,
        18px 18px 0 rgba(110, 231, 255, 0.25);
      cursor: pointer;
      overflow: hidden;
      transition: all .5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-style: preserve-3d;
      outline: none;
    }

    /* open states: hover / focus-within / .open for mobile tap */
    .login-card:hover,
    .login-card:focus-within,
    .login-card.open{
      height: 300px;
      transform: translateZ(20px) rotateX(4deg) rotateY(-4deg);
      box-shadow:
        14px 14px 0 #111,
        28px 28px 0 rgba(255, 214, 110, 0.25),
        0 0 55px rgba(110, 231, 255, 0.55);
    }

    .login-title{
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: inherit;
      transition: all .4s ease;
    }

    .login-text{
      color: #111;
      font-weight: 800;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 2px 2px 0 rgba(255,255,255,.45);
      transition: all .4s ease;
    }

    .login-card:hover .login-text,
    .login-card:focus-within .login-text,
    .login-card.open .login-text{
      opacity: 0;
      transform: translateY(-30px) scale(.85);
    }

    .login-form{
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 22px;
      opacity: 0;
      transform: translateY(30px) scale(.88);
      transition: all .5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .login-card:hover .login-form,
    .login-card:focus-within .login-form,
    .login-card.open .login-form{
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .input-group{
      width: 100%;
      margin-bottom: 14px;
    }

    .login-input{
      width: 100%;
      padding: 12px 12px;
      background: rgba(255, 255, 255, 0.92);
      border: 3px solid #111;
      border-radius: 10px;
      font-weight: 700;
      color: #111;
      box-shadow: 4px 4px 0 #111;
      transition: all .25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-size: 14px;
    }

    .login-input:focus{
      outline: none;
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #111;
    }

    .login-input::placeholder{ color: #111; opacity: .55; }

    .login-btn{
      width: 100%;
      padding: 12px;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 4px 4px 0 rgba(17, 17, 17, 0.25);
      transition: all .25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .login-btn:hover{
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(17, 17, 17, 0.25);
      background: #2a2a2a;
    }

    .login-btn:disabled{
      opacity: .65;
      cursor: not-allowed;
      transform: none;
    }

    .links{
      width: 100%;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      font-size: 13px;
      font-weight: 600;
    }
    .links a{
      color: #111;
      text-decoration: none;
      border-bottom: 2px solid rgba(17,17,17,.25);
      padding-bottom: 2px;
    }
    .links a:hover{ border-bottom-color: rgba(17,17,17,.7); }

    .hint{
      width: 100%;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(17,17,17,.75);
      line-height: 1.4;
      min-height: 18px;
      text-align: left;
      font-weight: 600;
    }

    /* light “glitch” sweep */
    .login-card::before{
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      transition: left .7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .login-card:hover::before,
    .login-card:focus-within::before,
    .login-card.open::before{
      left: 100%;
    }

    /* geometric accent */
    .login-card::after{
      content: "";
      position: absolute;
      top: -4px;
      right: -4px;
      width: 22px;
      height: 22px;
      background: #111;
      clip-path: polygon(0 0, 100% 0, 100% 100%);
      transition: all .6s ease;
    }
    .login-card:hover::after,
    .login-card:focus-within::after,
    .login-card.open::after{
      background: #6ee7ff;
      transform: rotate(0deg);
    }

    /* pulse behind */
    .login-container::before{
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(110,231,255,.18);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all .6s ease;
      z-index: -1;
      filter: blur(0.5px);
    }
    .login-container:hover::before{
      width: 420px;
      height: 420px;
    }

    @media (max-width: 420px){
      .login-card{ height: 86px; }
      .login-title{ height: 86px; }
      .login-card:hover,
      .login-card:focus-within,
      .login-card.open{ height: 308px; }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-card" id="card" tabindex="0" aria-label="Login Card">
      <div class="login-title">
        <span class="login-text">Login</span>
      </div>

      <div class="login-form">
        <div class="input-group">
          <input id="email" class="login-input" type="email" placeholder="Email" autocomplete="username" required />
        </div>

        <div class="input-group">
          <input id="password" class="login-input" type="password" placeholder="Password" autocomplete="current-password" required />
        </div>

        <button id="loginBtn" class="login-btn" type="button">ENTER ZONE</button>

        <div class="links">
          <a href="register.html">Register</a>
          <a href="forgot.html">Forgot password?</a>
        </div>

        <div class="hint" id="msg"></div>
      </div>
    </div>
  </div>

  <script type="module">
  import { auth, db } from "./firebase.js";
  import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const card    = document.getElementById("card");
  const emailEl = document.getElementById("email");
  const passEl  = document.getElementById("password");
  const btn     = document.getElementById("loginBtn");
  const msg     = document.getElementById("msg");

  console.log("Firebase projectId =", auth?.app?.options?.projectId);
  console.log("Firebase authDomain =", auth?.app?.options?.authDomain);
  console.log("apiKey =", auth?.app?.options?.apiKey);

  const setMsg = (t) => (msg.textContent = t || "");
  const setLoading = (b) => {
    btn.disabled = b;
    btn.textContent = b ? "Signing in..." : "ENTER ZONE";
  };

  function friendlyError(err){
    const code = err?.code || "";
    if(code === "auth/invalid-credential") return "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
    if(code === "auth/invalid-email") return "รูปแบบอีเมลไม่ถูกต้อง";
    if(code === "auth/missing-password") return "กรุณากรอกรหัสผ่าน";
    if(code === "auth/too-many-requests") return "ลองใหม่ภายหลัง (ลองผิดหลายครั้งเกินไป)";
    if(code === "auth/network-request-failed") return "เน็ตสะดุด ลองใหม่อีกที";
    return `ล็อกอินไม่สำเร็จ (${code || "unknown"})`;
  }

  async function login(){
    const email = emailEl.value.trim();
    const password = passEl.value; // ไม่ trim

    if(!email || !password){
      setMsg("กรุณากรอกอีเมลและรหัสผ่านให้ครบ");
      card?.classList?.add("open");
      return;
    }

    try{
      setMsg("");
      setLoading(true);

      const cred = await signInWithEmailAndPassword(auth, email, password);

      // ✅ เช็คว่ามี username ใน Firestore แล้วหรือยัง
      const ref = doc(db, "users", cred.user.uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : null;

      localStorage.setItem("loggedInUser", cred.user.email || email);

      if (data?.username) {
        localStorage.setItem("username", data.username);
        location.href = "index.html";
      } else {
        location.href = "username.html";
      }

    }catch(err){
      console.error("LOGIN ERROR =>", err);
      setMsg(friendlyError(err));
    }finally{
      setLoading(false);
    }
  }

  btn.addEventListener("click", login);
  [emailEl, passEl].forEach(el=>{
    el.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });
  });
</script>

</body>
</html>
